name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸å·¥ä½œæµå†™å…¥ä»£ç åº“å†…å®¹
  id-token: write  # å…è®¸å·¥ä½œæµä½¿ç”¨ ID Token
  actions: read  # å…è®¸å·¥ä½œæµä½¿ç”¨ Actions API

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.4'  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
        channel: 'stable'

    - name: Enable Windows desktop support
      run: flutter config --enable-windows-desktop
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Build Windows executable
      run: flutter build windows --release
      
    - name: Create Windows release archive
      run: |
        cd build\windows\x64\runner\Release
        7z a -tzip ..\..\..\..\rebound_particles_windows.zip *
      shell: cmd
      
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-release
        path: rebound_particles_windows.zip

  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.4'  
        channel: 'stable'
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Build Android APK (split per ABI)
      run: flutter build apk --release --split-per-abi
      
    - name: Rename APK files
      run: |
        cd build/app/outputs/flutter-apk/
        mv app-arm64-v8a-release.apk rebound_particles_arm64-v8a.apk || true
        mv app-armeabi-v7a-release.apk rebound_particles_armeabi-v7a.apk || true
        mv app-x86_64-release.apk rebound_particles_x86_64.apk || true
        ls -la
        
    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: build/app/outputs/flutter-apk/*.apk

  create-release:
    needs: [build-windows, build-android]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-release
        
    - name: Download Android artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-release
        
    - name: Get version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: é‡å­ç²’å­æ¨¡æ‹Ÿå™¨ ${{ steps.version.outputs.VERSION }}
        body: |
          ## ğŸš€ é‡å­ç²’å­æ¨¡æ‹Ÿå™¨ Release ${{ steps.version.outputs.VERSION }}
          
          ### ğŸ“± Android APK
          - **arm64-v8a**: é€‚ç”¨äºå¤§å¤šæ•°ç°ä»£Androidè®¾å¤‡ï¼ˆ64ä½ARMï¼‰
          - **armeabi-v7a**: é€‚ç”¨äºè¾ƒè€çš„Androidè®¾å¤‡ï¼ˆ32ä½ARMï¼‰
          - **x86_64**: é€‚ç”¨äºx86_64æ¶æ„çš„Androidè®¾å¤‡ï¼ˆå¦‚æ¨¡æ‹Ÿå™¨ï¼‰
          
          ### ğŸ’» Windows
          - **Windows executable**: é€‚ç”¨äºWindows 10/11ç³»ç»Ÿ
          
          ### ğŸ® åŠŸèƒ½ç‰¹æ€§
          - å®æ—¶ç²’å­ç‰©ç†æ¨¡æ‹Ÿ
          - é‡å­æ•ˆæœå¯è§†åŒ–
          - äº¤äº’å¼ç•Œé¢æ§åˆ¶
          - é«˜æ€§èƒ½æ¸²æŸ“å¼•æ“
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          **Android**:
          - Android 5.0 (API level 21) æˆ–æ›´é«˜ç‰ˆæœ¬
          
          **Windows**:
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - x64 æ¶æ„
          
          ---
          
          Built with Flutter ğŸ’™
        draft: false
        prerelease: false
        
    - name: Upload Windows Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./rebound_particles_windows.zip
        asset_name: rebound_particles_windows_${{ steps.version.outputs.VERSION }}.zip
        asset_content_type: application/zip
        
    - name: Upload Android ARM64 Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./rebound_particles_arm64-v8a.apk
        asset_name: rebound_particles_arm64-v8a_${{ steps.version.outputs.VERSION }}.apk
        asset_content_type: application/vnd.android.package-archive
        
    - name: Upload Android ARMv7 Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./rebound_particles_armeabi-v7a.apk
        asset_name: rebound_particles_armeabi-v7a_${{ steps.version.outputs.VERSION }}.apk
        asset_content_type: application/vnd.android.package-archive
        
    - name: Upload Android x86_64 Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./rebound_particles_x86_64.apk
        asset_name: rebound_particles_x86_64_${{ steps.version.outputs.VERSION }}.apk
        asset_content_type: application/vnd.android.package-archive
